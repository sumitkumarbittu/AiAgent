<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Sentiment Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container mt-5">
        <h1 class="text-center mb-4">🧠 Customer Sentiment Analyzer</h1>

        <!-- 🔹 Analyze Section -->
        <div id="analyzeSection" class="card shadow p-4">
            <form id="analyzeForm">
                <div class="mb-3">
                    <label for="textInput" class="form-label">Enter text to analyze:</label>
                    <textarea id="textInput" class="form-control" rows="3" placeholder="Type customer feedback here..."></textarea>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Analyze Sentiment</button>
                </div>
            </form>
        </div>

        <!-- 🔹 Result Section -->
        <div id="singleResultSection" class="card shadow p-4 mt-4" style="display: none;">
            <h4 class="card-title mb-3">Analysis Result</h4>
            <p><strong>Text:</strong> <span id="resultText"></span></p>
            <p><strong>Sentiment:</strong> <span id="sentimentResult" class="fw-bold"></span></p>

            <div class="d-flex gap-2 mt-3">
                <button id="sendAlertBtn" class="btn btn-danger">
                    🚨 Send Alert
                </button>
                <button id="newAnalysisBtn" class="btn btn-outline-primary">
                    🔁 Analyze Another
                </button>
            </div>
        </div>
    </div>

    <!-- 🔹 Script Section -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeForm = document.getElementById('analyzeForm');
            const sendAlertBtn = document.getElementById('sendAlertBtn');
            const newAnalysisBtn = document.getElementById('newAnalysisBtn');
            const singleResultSection = document.getElementById('singleResultSection');
            const analyzeSection = document.getElementById('analyzeSection');
            const resultText = document.getElementById('resultText');
            const sentimentResult = document.getElementById('sentimentResult');
            const textInput = document.getElementById('textInput');

            // 🧠 Handle Sentiment Analysis
            analyzeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = textInput.value.trim();
                if (!text) {
                    alert("Please enter some text to analyze.");
                    return;
                }

                try {
                    const response = await fetch("/analyze/single", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ text })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        alert(result.error || "Something went wrong while analyzing.");
                        return;
                    }

                    resultText.textContent = result.text;
                    sentimentResult.textContent = `${result.sentiment.toUpperCase()} (${result.score.toFixed(2)})`;

                    analyzeSection.style.display = "none";
                    singleResultSection.style.display = "block";

                } catch (error) {
                    console.error(error);
                    alert("⚠️ Failed to connect to backend. Please ensure Flask and FastAPI are running.");
                }
            });

            // 🚨 Send Alert to Flask
            sendAlertBtn.addEventListener('click', async () => {
                const text = resultText.textContent;
                const sentiment = sentimentResult.textContent.split(" ")[0].toLowerCase();
                const scoreMatch = sentimentResult.textContent.match(/\(([^)]+)\)/);
                const score = scoreMatch ? parseFloat(scoreMatch[1]) : 0.5;

                const payload = {
                    text: text,
                    sentiment: sentiment,
                    score: score,
                    urgency: sentiment === "negative" ? "High" : "Medium",
                    recommendation: sentiment === "negative"
                        ? "Immediate response recommended."
                        : "Monitor sentiment."
                };

                try {
                    const response = await fetch("/send-alert", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert("✅ Alert sent successfully!");
                        console.log("Alert response:", data);
                    } else {
                        alert(`❌ Failed to send alert: ${data.error}`);
                    }

                } catch (err) {
                    console.error(err);
                    alert("⚠️ Could not send alert. Check console for details.");
                }
            });

            // 🔁 Reset and start new analysis
            newAnalysisBtn.addEventListener('click', () => {
                singleResultSection.style.display = "none";
                analyzeSection.style.display = "block";
                textInput.value = "";
            });
        });
    </script>
</body>
</html>
